Auth_Screen.Dart
// lib/auth_screen.dart – ĐẸP + CHẠY NGON
import 'package:flutter/material.dart';
import 'package:firebase_database/firebase_database.dart';
import 'main.dart';

class AuthPage extends StatefulWidget {
  const AuthPage({super.key});
  @override
  State<AuthPage> createState() => _AuthPageState();
}

class _AuthPageState extends State<AuthPage> {
  final _emailCtrl = TextEditingController();
  final _passCtrl = TextEditingController();
  final _nameCtrl = TextEditingController();
  bool _isLogin = true;
  bool _loading = false;

  Future<void> _submit() async {
    final email = _emailCtrl.text.trim().toLowerCase();
    final pass = _passCtrl.text.trim();
    final name = _nameCtrl.text.trim();

    if (email.isEmpty || pass.isEmpty || (!_isLogin && name.isEmpty)) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Vui lòng điền đầy đủ")));
      return;
    }

    setState(() => _loading = true);

    try {
      final db = FirebaseDatabase.instance.ref("users");
      if (_isLogin) {
        final snap = await db.get();
        if (!snap.exists) throw "Chưa có tài khoản";
        final users = snap.value as Map;
        bool found = false;
        users.forEach((k, v) {
          final user = v as Map;
          if (user["email"] == email && user["password"] == pass) found = true;
        });
        if (!found) throw "Email hoặc mật khẩu sai";
        Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => const HomePage()));
      } else {
        final check = await db.get();
        if (check.exists) {
          final users = check.value as Map;
          bool exists = users.values.any((v) => (v as Map)["email"] == email);
          if (exists) throw "Email đã tồn tại";
        }
        await db.push().set({"name": name, "email": email, "password": pass, "createdAt": ServerValue.timestamp});
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Đăng ký thành công!"), backgroundColor: Colors.green));
        Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => const HomePage()));
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(e.toString()), backgroundColor: Colors.red));
    } finally {
      setState(() => _loading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(colors: [Color(0xFF001F3F), Color(0xFF002855)], begin: Alignment.topCenter, end: Alignment.bottomCenter),
        ),
        child: Center(
          child: Card(
            elevation: 12,
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(30)),
            child: Container(
              width: 400,
              padding: const EdgeInsets.all(40),
              decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(30)),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Icon(Icons.electrical_services, size: 80, color: Color(0xFF001F3F)),
                  const SizedBox(height: 20),
                  Text(_isLogin ? "ĐĂNG NHẬP SCADA" : "TẠO TÀI KHOẢN", style: const TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: Color(0xFF001F3F))),
                  const SizedBox(height: 30),
                  if (!_isLogin) TextField(controller: _nameCtrl, decoration: const InputDecoration(labelText: "Họ tên", prefixIcon: Icon(Icons.person))),
                  TextField(controller: _emailCtrl, keyboardType: TextInputType.emailAddress, decoration: const InputDecoration(labelText: "Email", prefixIcon: Icon(Icons.email))),
                  TextField(controller: _passCtrl, obscureText: true, decoration: const InputDecoration(labelText: "Mật khẩu", prefixIcon: Icon(Icons.lock))),
                  const SizedBox(height: 30),
                  SizedBox(
                    width: double.infinity,
                    height: 56,
                    child: ElevatedButton(
                      style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF001F3F), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(30))),
                      onPressed: _loading ? null : _submit,
                      child: _loading ? const CircularProgressIndicator(color: Colors.white) : Text(_isLogin ? "ĐĂNG NHẬP" : "ĐĂNG KÝ", style: const TextStyle(fontSize: 18, color: Colors.white)),
                    ),
                  ),
                  TextButton(onPressed: () => setState(() => _isLogin = !_isLogin), child: Text(_isLogin ? "Chưa có tài khoản?" : "Đã có tài khoản?", style: const TextStyle(color: Color(0xFF001F3F)))),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
Main.Dart
// lib/main.dart – SIÊU PHẨM SCADA 2025 – HOÀN CHỈNH 100%, KHÔNG CÒN LỖI
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_database/firebase_database.dart';
import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;

import 'auth_screen.dart';
import 'history_page.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  runApp(const TuBienApp());
}

class TuBienApp extends StatelessWidget {
  const TuBienApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'TỦ ĐIỆN SCADA',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        useMaterial3: true,
        colorSchemeSeed: const Color(0xFF001F3F),
        brightness: Brightness.light,
        scaffoldBackgroundColor: const Color(0xFFF8FAFC),
        appBarTheme: const AppBarTheme(
          backgroundColor: Color(0xFF001F3F),
          foregroundColor: Colors.white,
          elevation: 6,
          centerTitle: true,
          titleTextStyle: TextStyle(fontSize: 22, fontWeight: FontWeight.bold),
        ),
        cardTheme: CardThemeData(
          elevation: 12,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
          color: Colors.white,
          shadowColor: Colors.black.withValues(alpha: 0.18),
          surfaceTintColor: Colors.transparent,
        ),
      ),
      home: const AuthPage(),
    );
  }
}

class HomePage extends StatefulWidget {
  const HomePage({super.key});
  @override
  State<HomePage> createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> with TickerProviderStateMixin {
  late AnimationController _fanCtrl;
  late AnimationController blinkCtrl;
  late DatabaseReference db;

  double? voltage, current, power, pf, temp, humi;
  bool mainPower = true, fanOn = false, buzzerOn = false;

  double currentWarning = 8.0, currentDanger = 10.0, currentCutoff = 12.0;
  double tempWarning = 50.0, tempDanger = 60.0, tempCutoff = 70.0;

  @override
  void initState() {
    super.initState();
    _fanCtrl = AnimationController(vsync: this, duration: const Duration(seconds: 1))..repeat();
    blinkCtrl = AnimationController(vsync: this, duration: const Duration(milliseconds: 400))..repeat();
    db = FirebaseDatabase.instance.ref();

    db.child("sensor").onValue.listen((event) {
      final data = event.snapshot.value as Map<dynamic, dynamic>?;
      if (data != null && mounted) {
        setState(() {
          voltage = (data['voltage'] as num?)?.toDouble();
          current = (data['current'] as num?)?.toDouble();
          power   = (data['power'] as num?)?.toDouble();
          pf      = (data['pf'] as num?)?.toDouble();
          temp    = (data['temp'] as num?)?.toDouble();
          humi    = (data['humi'] as num?)?.toDouble();
        });
      }
    });

    db.child("status/main_power").onValue.listen((e) => setState(() => mainPower = e.snapshot.value as bool? ?? true));
    db.child("status/fan").onValue.listen((e) => setState(() => fanOn = e.snapshot.value as bool? ?? false));
    db.child("status/buzzer").onValue.listen((e) => setState(() => buzzerOn = e.snapshot.value as bool? ?? false));

    db.child("threshold/currentWarning").onValue.listen((e) => setState(() => currentWarning = (e.snapshot.value as num?)?.toDouble() ?? 8.0));
    db.child("threshold/currentDanger").onValue.listen((e) => setState(() => currentDanger = (e.snapshot.value as num?)?.toDouble() ?? 10.0));
    db.child("threshold/currentCutoff").onValue.listen((e) => setState(() => currentCutoff = (e.snapshot.value as num?)?.toDouble() ?? 12.0));
    db.child("threshold/tempWarning").onValue.listen((e) => setState(() => tempWarning = (e.snapshot.value as num?)?.toDouble() ?? 50.0));
    db.child("threshold/tempDanger").onValue.listen((e) => setState(() => tempDanger = (e.snapshot.value as num?)?.toDouble() ?? 60.0));
    db.child("threshold/tempCutoff").onValue.listen((e) => setState(() => tempCutoff = (e.snapshot.value as num?)?.toDouble() ?? 70.0));
  }

  void toggleFan() {
    final newState = !fanOn;
    db.child("control/fan").set(newState);
    db.child("status/fan").set(newState);
  }

  void emergencyCut() async {
    final ctrl = TextEditingController();
    final ok = await showDialog<bool>(
      context: context,
      builder: (_) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        icon: const Icon(Icons.warning_amber, color: Colors.red, size: 60),
        title: const Text("NGẮT ĐIỆN KHẨN CẤP", style: TextStyle(fontWeight: FontWeight.bold)),
        content: TextField(
          controller: ctrl,
          obscureText: true,
          keyboardType: TextInputType.number,
          decoration: const InputDecoration(hintText: "Mã bảo vệ: 123456", filled: true),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text("Hủy")),
          FilledButton(
            style: FilledButton.styleFrom(backgroundColor: Colors.red),
            onPressed: () => ctrl.text == "123456" ? Navigator.pop(context, true) : null,
            child: const Text("NGẮT NGAY", style: TextStyle(fontWeight: FontWeight.bold)),
          ),
        ],
      ),
    );
    if (ok == true) {
      db.child("control/main_power").set(false);
      db.child("status/main_power").set(false);
    }
  }

  void turnOnPower() {
    db.child("control/main_power").set(true);
    db.child("status/main_power").set(true);
    db.child("status/buzzer").set(false);
  }

  int getLevel() {
    if (current != null && temp != null) {
      if (current! >= currentCutoff || temp! >= tempCutoff) return 3;
      if (current! >= currentDanger || temp! >= tempDanger) return 2;
      if (current! >= currentWarning || temp! >= tempWarning) return 1;
    }
    return 0;
  }

  @override
  Widget build(BuildContext context) {
    final level = getLevel();
    final blink = blinkCtrl.value > 0.5;

    if (level == 3 && mainPower) {
      Future.microtask(() {
        db.child("control/main_power").set(false);
        db.child("status/main_power").set(false);
        db.child("status/buzzer").set(true);
      });
    }

    return Scaffold(
      appBar: AppBar(title: const Text("TỦ ĐIỆN SCADA")),
      floatingActionButton: FloatingActionButton(
        backgroundColor: const Color(0xFF001F3F),
        child: const Icon(Icons.history, color: Colors.white),
        onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (_) => const HistoryPage())),
      ),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            colors: [Color(0xFF001F3F), Color(0xFF002855)],
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
          ),
        ),
        child: Stack(
          children: [
            if (level == 3)
              AnimatedBuilder(
                animation: blinkCtrl,
                builder: (_, __) => Container(color: Colors.red.withValues(alpha: blink ? 0.4 : 0.0)),
              ),
            SingleChildScrollView(
              padding: const EdgeInsets.all(16),
              child: Column(
                children: [
                  const SizedBox(height: 10),
                  Card(
                    child: Padding(
                      padding: const EdgeInsets.all(24),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                        children: [
                          LedIndicator(color: Colors.green, label: "BÌNH THƯỜNG", active: level == 0),
                          LedIndicator(color: Colors.amber, label: "CẢNH BÁO", active: level == 1),
                          LedIndicator(color: Colors.red, label: "NGUY HIỂM", active: level >= 2),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                  Card(
                    color: mainPower
                        ? (level == 0 ? Colors.green[700]! : level == 1 ? Colors.amber[700]! : Colors.red[900]!)
                        : Colors.red[900]!,
                    child: ListTile(
                      leading: Icon(
                        level == 3 ? Icons.campaign_outlined : (mainPower ? Icons.power : Icons.power_off),
                        size: 56, color: Colors.white,
                      ),
                      title: Text(
                        level == 3 ? "MỨC 3 – ĐÃ TỰ NGẮT!" : mainPower ? "TRẠNG THÁI: MỨC $level" : "ĐÃ NGẮT NGUỒN",
                        style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 20),
                      ),
                      trailing: !mainPower
                          ? FilledButton.icon(
                              onPressed: turnOnPower,
                              icon: const Icon(Icons.power_settings_new),
                              label: const Text("BẬT LẠI"),
                              style: FilledButton.styleFrom(backgroundColor: Colors.green[700]),
                            )
                          : null,
                    ),
                  ),
                  const SizedBox(height: 24),

                  // ĐÃ SỬA: childAspectRatio = 1.7 + FittedBox → KHÔNG CÒN OVERFLOW
                  GridView.count(
                    shrinkWrap: true,
                    physics: const NeverScrollableScrollPhysics(),
                    crossAxisCount: 2,
                    mainAxisSpacing: 16,
                    crossAxisSpacing: 16,
                    childAspectRatio: 1.8, // TĂNG ĐỦ ĐỂ KHÔNG OVERFLOW
                    children: [
                      UnifiedInfoCard(title: "Điện áp", value: voltage, unit: "V", icon: Icons.electrical_services),
                      UnifiedInfoCard(title: "Dòng điện", value: current, unit: "A", icon: Icons.bolt, warning: currentWarning, danger: currentDanger),
                      UnifiedInfoCard(title: "Công suất", value: power, unit: "W", icon: Icons.power),
                      UnifiedInfoCard(title: "Cos φ", value: pf, unit: "", icon: Icons.functions),
                      UnifiedInfoCard(title: "Nhiệt độ", value: temp, unit: "°C", icon: Icons.thermostat, warning: tempWarning, danger: tempDanger),
                      UnifiedInfoCard(title: "Độ ẩm", value: humi, unit: "%", icon: Icons.water_drop),
                    ],
                  ),

                  const SizedBox(height: 24),
                  Card(
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text("CÀI ĐẶT NGƯỠNG CẢNH BÁO", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Color(0xFF001F3F))),
                          const SizedBox(height: 16),
                          _buildSlider("Dòng điện CẢNH BÁO", currentWarning, 6.0, 12.0, "A", (v) => db.child("threshold/currentWarning").set(v)),
                          _buildSlider("Dòng điện NGUY HIỂM", currentDanger, 8.0, 15.0, "A", (v) => db.child("threshold/currentDanger").set(v)),
                          _buildSlider("Dòng điện TỰ NGẮT", currentCutoff, 10.0, 25.0, "A", (v) => db.child("threshold/currentCutoff").set(v)),
                          const Divider(height: 40, thickness: 1),
                          _buildSlider("Nhiệt độ CẢNH BÁO", tempWarning, 40.0, 70.0, "°C", (v) => db.child("threshold/tempWarning").set(v)),
                          _buildSlider("Nhiệt độ NGUY HIỂM", tempDanger, 50.0, 80.0, "°C", (v) => db.child("threshold/tempDanger").set(v)),
                          _buildSlider("Nhiệt độ TỰ NGẮT", tempCutoff, 60.0, 100.0, "°C", (v) => db.child("threshold/tempCutoff").set(v)),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(height: 40),
                  Row(
                    children: [
                      Expanded(child: GestureDetector(onTap: toggleFan, child: FanButton(fanOn: fanOn, controller: _fanCtrl))),
                      const SizedBox(width: 16),
                      Expanded(
                        child: FilledButton.icon(
                          onPressed: mainPower ? emergencyCut : null,
                          icon: const Icon(Icons.warning_amber, size: 36),
                          label: const Text("NGẮT KHẨN CẤP", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                          style: FilledButton.styleFrom(backgroundColor: Colors.red, padding: const EdgeInsets.symmetric(vertical: 24)),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 100),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSlider(String label, double value, double min, double max, String unit, Function(double) onSave) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        children: [
          SizedBox(width: 200, child: Text(label, style: const TextStyle(fontSize: 15, fontWeight: FontWeight.w600))),
          Expanded(
            child: Slider(
              value: value.clamp(min, max),
              min: min, max: max,
              divisions: ((max - min) * 2).toInt(),
              label: value.toStringAsFixed(1),
              activeColor: const Color(0xFF001F3F),
              onChanged: (v) => setState(() => value = v),
              onChangeEnd: onSave,
            ),
          ),
          SizedBox(width: 80, child: Text("${value.toStringAsFixed(1)}$unit", style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16))),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _fanCtrl.dispose();
    blinkCtrl.dispose();
    super.dispose();
  }
}

// CARD ĐỒNG BỘ MÀU – ĐÃ SỬA HOÀN HẢO, KHÔNG BAO GIỜ OVERFLOW
class UnifiedInfoCard extends StatelessWidget {
  final String title;
  final double? value;
  final String unit;
  final IconData icon;
  final double? warning;
  final double? danger;

  const UnifiedInfoCard({
    required this.title,
    required this.value,
    required this.unit,
    required this.icon,
    this.warning,
    this.danger,
    super.key,
  });

  Color _getColor() {
    if (value == null) return const Color(0xFF001F3F);
    if (danger != null && value! >= danger!) return Colors.red;
    if (warning != null && value! >= warning!) return Colors.orange;
    return const Color(0xFF001F3F);
  }

  @override
  Widget build(BuildContext context) {
    final color = _getColor();
    final displayValue = value != null
        ? (unit == "" ? value!.toStringAsFixed(2) : value!.toStringAsFixed(1))
        : "--";

    return Card(
      elevation: 12,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 10, horizontal: 12), // GIẢM PADDING
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(24),
          gradient: LinearGradient(
            colors: [color.withValues(alpha: 0.95), color.withValues(alpha: 0.85)],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, size: 36, color: Colors.white), // GIẢM ICON
            const SizedBox(height: 6),
            Text(
              title,
              style: const TextStyle(color: Colors.white70, fontSize: 12, fontWeight: FontWeight.w600),
              textAlign: TextAlign.center,
              maxLines: 2,
              overflow: TextOverflow.ellipsis,
            ),
            const SizedBox(height: 4),
            FittedBox(
              fit: BoxFit.scaleDown,
              child: Text(
                "$displayValue $unit",
                style: const TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// LED INDICATOR
class LedIndicator extends StatelessWidget {
  final Color color; final String label; final bool active;
  const LedIndicator({required this.color, required this.label, required this.active, super.key});
  @override
  Widget build(BuildContext context) => Column(
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: 64, height: 64,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: active ? color : Colors.transparent,
              border: Border.all(color: active ? color : Colors.grey, width: 5),
              boxShadow: active ? [BoxShadow(color: color.withValues(alpha: 0.8), blurRadius: 25, spreadRadius: 8)] : null,
            ),
          ),
          const SizedBox(height: 8),
          Text(label, style: TextStyle(fontSize: 13, fontWeight: active ? FontWeight.bold : FontWeight.normal, color: active ? color : null)),
        ],
      );
}

// FAN BUTTON
class FanButton extends StatelessWidget {
  final bool fanOn; final AnimationController controller;
  const FanButton({required this.fanOn, required this.controller, super.key});
  @override
  Widget build(BuildContext context) => AnimatedContainer(
        duration: const Duration(milliseconds: 300),
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          gradient: LinearGradient(colors: fanOn ? [Colors.cyan, Colors.blue] : [Colors.grey[600]!, Colors.grey[800]!]),
          borderRadius: BorderRadius.circular(20),
          boxShadow: const [BoxShadow(color: Colors.black26, blurRadius: 10, offset: Offset(0, 5))],
        ),
        child: Column(children: [
          RotationTransition(
            turns: fanOn ? controller : const AlwaysStoppedAnimation(0),
            child: const Icon(Icons.wind_power, size: 64, color: Colors.white),
          ),
          const SizedBox(height: 12),
          Text(
            fanOn ? "QUẠT ĐANG CHẠY" : "BẬT QUẠT TẢN NHIỆT",
            textAlign: TextAlign.center,
            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 15),
          ),
        ]),
      );
}

// DEFAULT FIREBASE OPTIONS
class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) return web;
    switch (defaultTargetPlatform) {
      case TargetPlatform.android: return android;
      case TargetPlatform.iOS: return ios;
      default: throw UnsupportedError('Not supported');
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: "AIzaSyDmsxUiY_35EduINZwaoPJdbkNStrSc_6s",
    authDomain: "tu-dien-3943b.firebaseapp.com",
    databaseURL: "https://tu-dien-3943b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tu-dien-3943b",
    storageBucket: "tu-dien-3943b.firebasestorage.app",
    messagingSenderId: "835744421276",
    appId: "1:835744421276:web:5e16016516eedd34c7a459",
  );
  static const FirebaseOptions android = FirebaseOptions(
    apiKey: "AIzaSyDmsxUiY_35EduINZwaoPJdbkNStrSc_6s",
    appId: "1:835744421276:android:5e16016516eedd34c7a459",
    messagingSenderId: "835744421276",
    projectId: "tu-dien-3943b",
    storageBucket: "tu-dien-3943b.firebasestorage.app",
    databaseURL: "https://tu-dien-3943b-default-rtdb.asia-southeast1.firebasedatabase.app",
  );
  static const FirebaseOptions ios = FirebaseOptions(
    apiKey: "AIzaSyDmsxUiY_35EduINZwaoPJdbkNStrSc_6s",
    appId: "1:835744421276:ios:5e16016516eedd34c7a459",
    messagingSenderId: "835744421276",
    projectId: "tu-dien-3943b",
    storageBucket: "tu-dien-3943b.firebasestorage.app",
    iosBundleId: "com.example.scadaTuDien",
  );
}
History_page.Dart
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_database/firebase_database.dart';
import 'package:fl_chart/fl_chart.dart';
import 'package:intl/intl.dart';
import 'package:table_calendar/table_calendar.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:flutter/foundation.dart';
import 'package:intl/date_symbol_data_local.dart' as intl_local;

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  // Khởi tạo dữ liệu định dạng ngày tiếng Việt (bắt buộc)
  await intl_local.initializeDateFormatting('vi_VN', null);

  // Delay nhỏ cực kỳ hiệu quả khi chạy trên Web (giải quyết race condition)
  if (kIsWeb) {
    await Future.delayed(const Duration(milliseconds: 100));
  }

  runApp(const ScadaApp());
}

class ScadaApp extends StatelessWidget {
  const ScadaApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'SCADA Tủ Điện',
      theme: ThemeData(
        useMaterial3: true,
        primaryColor: const Color(0xFF001F3F),
        colorScheme: ColorScheme.fromSeed(
          seedColor: const Color(0xFF001F3F),
          brightness: Brightness.light,
        ),
        scaffoldBackgroundColor: Colors.white,
      ),
      localizationsDelegates: const [
        GlobalMaterialLocalizations.delegate,
        GlobalWidgetsLocalizations.delegate,
        GlobalCupertinoLocalizations.delegate,
      ],
      supportedLocales: const [
        Locale('vi', 'VN'),
        Locale('en', 'US'),
      ],
      locale: const Locale('vi', 'VN'),
      localeResolutionCallback: (locale, supportedLocales) {
        return locale ?? const Locale('vi', 'VN');
      },
      home: const HistoryPage(),
    );
  }
}

enum TimeRange { live, min5, min10, hour1, hour6, hour12, hour24 }

extension TimeRangeExt on TimeRange {
  String get label {
    switch (this) {
      case TimeRange.live: return 'Trực tiếp';
      case TimeRange.min5: return '5 phút';
      case TimeRange.min10: return '10 phút';
      case TimeRange.hour1: return '1 giờ';
      case TimeRange.hour6: return '6 giờ';
      case TimeRange.hour12: return '12 giờ';
      case TimeRange.hour24: return '24 giờ';
    }
  }

  Duration get duration {
    switch (this) {
      case TimeRange.live: return const Duration(minutes: 1);
      case TimeRange.min5: return const Duration(minutes: 5);
      case TimeRange.min10: return const Duration(minutes: 10);
      case TimeRange.hour1: return const Duration(hours: 1);
      case TimeRange.hour6: return const Duration(hours: 6);
      case TimeRange.hour12: return const Duration(hours: 12);
      case TimeRange.hour24: return const Duration(hours: 24);
    }
  }

  int get groupSeconds {
    switch (this) {
      case TimeRange.live: return 0;
      case TimeRange.min5: return 0;
      case TimeRange.min10: return 2;
      case TimeRange.hour1: return 15;
      case TimeRange.hour6: return 60;
      case TimeRange.hour12: return 120;
      case TimeRange.hour24: return 300;
    }
  }
}

class HistoryPage extends StatefulWidget {
  const HistoryPage({super.key});

  @override
  State<HistoryPage> createState() => _HistoryPageState();
}

class _HistoryPageState extends State<HistoryPage> {
  final db = FirebaseDatabase.instance.ref("history");

  bool _showCalendar = false;
  bool _localeReady = false; // Trạng thái chờ locale load xong

  TimeRange _selectedRange = TimeRange.live;
  DateTime _selectedDate = DateTime.now();
  DateTime _focusedDay = DateTime.now();

  List<FlSpot> vSpots = [], iSpots = [], pSpots = [];
  double currentV = 0, currentI = 0, currentP = 0;

  StreamSubscription<DatabaseEvent>? _liveSubscription;
  bool isLoading = false;
  final double fixedMaxY = 1000.0;

  @override
  void initState() {
    super.initState();
    _prepareLocale();
    _loadDataForMode();
  }

  Future<void> _prepareLocale() async {
    // Đảm bảo an toàn 100% trên Web
    await intl_local.initializeDateFormatting('vi_VN', null);
    if (mounted) {
      setState(() {
        _localeReady = true;
      });
    }
  }

  @override
  void dispose() {
    _liveSubscription?.cancel();
    super.dispose();
  }

  bool _isSameDay(DateTime d1, DateTime d2) {
    return d1.year == d2.year && d1.month == d2.month && d1.day == d2.day;
  }

  void _onDaySelected(DateTime selectedDay, DateTime focusedDay) {
    setState(() {
      _selectedDate = selectedDay;
      _focusedDay = focusedDay;
      _showCalendar = false;

      if (!_isSameDay(selectedDay, DateTime.now())) {
        _selectedRange = TimeRange.hour24;
      } else {
        _selectedRange = TimeRange.live;
      }
    });
    _loadDataForMode();
  }

  void _switchRange(TimeRange range) {
    setState(() => _selectedRange = range);
    _loadDataForMode();
  }

  void _loadDataForMode() {
    setState(() {
      vSpots.clear();
      iSpots.clear();
      pSpots.clear();
      isLoading = true;
      currentV = currentI = currentP = 0;
    });

    _liveSubscription?.cancel();

    final isToday = _isSameDay(_selectedDate, DateTime.now());

    if (isToday && _selectedRange == TimeRange.live) {
      _startLiveStream();
    } else {
      _loadHistoryData();
    }
  }

  void _startLiveStream() {
    final now = DateTime.now();
    final startAt = now.subtract(const Duration(minutes: 1)).millisecondsSinceEpoch;

    _liveSubscription = db.orderByKey().startAt(startAt.toString()).onValue.listen(
      (event) {
        if (!mounted) return;
        if (event.snapshot.exists) {
          final data = event.snapshot.value as Map<dynamic, dynamic>?;
          if (data != null) _processRawData(data);
        }
        if (mounted) setState(() => isLoading = false);
      },
      onError: (_) => mounted ? setState(() => isLoading = false) : null,
    );
  }

  Future<void> _loadHistoryData() async {
    int startMs, endMs;
    final now = DateTime.now();
    final isToday = _isSameDay(_selectedDate, now);

    if (isToday) {
      startMs = now.subtract(_selectedRange.duration).millisecondsSinceEpoch;
      endMs = now.millisecondsSinceEpoch;
    } else {
      startMs = DateTime(_selectedDate.year, _selectedDate.month, _selectedDate.day).millisecondsSinceEpoch;
      endMs = DateTime(_selectedDate.year, _selectedDate.month, _selectedDate.day, 23, 59, 59).millisecondsSinceEpoch;
    }

    try {
      final snap = await db.orderByKey().startAt(startMs.toString()).endAt(endMs.toString()).get();
      if (!mounted) return;

      if (snap.exists) {
        final data = snap.value as Map<dynamic, dynamic>;
        final groupSec = isToday ? _selectedRange.groupSeconds : TimeRange.hour24.groupSeconds;
        _processAggregatedData(data, startMs, groupSec);
      } else {
        if (mounted) setState(() => isLoading = false);
      }
    } catch (e) {
      debugPrint('Lỗi load history: $e');
      if (mounted) setState(() => isLoading = false);
    }
  }

  void _processRawData(Map<dynamic, dynamic> data) {
    final sorted = _sortData(data);
    final v = <FlSpot>[], i = <FlSpot>[], p = <FlSpot>[];

    for (var item in sorted) {
      final x = (item['ts'] as int).toDouble();
      final valV = (item['voltage'] as num?)?.toDouble() ?? 0;
      final valI = (item['current'] as num?)?.toDouble() ?? 0;
      final valP = (item['power'] as num?)?.toDouble() ?? 0;

      v.add(FlSpot(x, valV));
      i.add(FlSpot(x, valI * 100));
      p.add(FlSpot(x, valP));
    }

    if (_selectedRange == TimeRange.live && v.length > 60) {
      v.removeRange(0, v.length - 60);
      i.removeRange(0, i.length - 60);
      p.removeRange(0, p.length - 60);
    }

    _updateChartState(v, i, p);
  }

  void _processAggregatedData(Map<dynamic, dynamic> data, int startMs, int groupSec) {
    if (groupSec == 0) return _processRawData(data);

    final points = _sortData(data);
    if (points.isEmpty) {
      _updateChartState([], [], []);
      return;
    }

    final v = <FlSpot>[], i = <FlSpot>[], p = <FlSpot>[];

    double sumV = 0, sumI = 0, sumP = 0;
    int count = 0;

    int bucketStart = points.first['ts'] as int;
    bucketStart -= bucketStart % (groupSec * 1000);
    final bucketSize = groupSec * 1000;

    for (var point in points) {
      final ts = point['ts'] as int;

      while (ts >= bucketStart + bucketSize) {
        if (count > 0) {
          final avgX = bucketStart + bucketSize / 2.0;
          v.add(FlSpot(avgX, sumV / count));
          i.add(FlSpot(avgX, (sumI / count) * 100));
          p.add(FlSpot(avgX, sumP / count));
        }
        bucketStart += bucketSize;
        sumV = sumI = sumP = 0;
        count = 0;
      }

      sumV += (point['voltage'] as num?)?.toDouble() ?? 0;
      sumI += (point['current'] as num?)?.toDouble() ?? 0;
      sumP += (point['power'] as num?)?.toDouble() ?? 0;
      count++;
    }

    if (count > 0) {
      final avgX = bucketStart + bucketSize / 2.0;
      v.add(FlSpot(avgX, sumV / count));
      i.add(FlSpot(avgX, (sumI / count) * 100));
      p.add(FlSpot(avgX, sumP / count));
    }

    _updateChartState(v, i, p);
  }

  void _updateChartState(List<FlSpot> v, List<FlSpot> i, List<FlSpot> p) {
    if (!mounted) return;
    setState(() {
      vSpots = v;
      iSpots = i;
      pSpots = p;
      isLoading = false;
      if (v.isNotEmpty) {
        currentV = v.last.y;
        currentI = i.last.y / 100;
        currentP = p.last.y;
      }
    });
  }

  List<Map<String, dynamic>> _sortData(Map<dynamic, dynamic> data) {
    final points = <Map<String, dynamic>>[];
    data.forEach((key, value) {
      if (key is String && RegExp(r'^\d+$').hasMatch(key)) {
        final val = value as Map<dynamic, dynamic>? ?? {};
        points.add({
          'ts': int.parse(key),
          'voltage': val['voltage'] ?? 0,
          'current': val['current'] ?? 0,
          'power': val['power'] ?? 0,
        });
      }
    });
    points.sort((a, b) => (a['ts'] as int).compareTo(b['ts'] as int));
    return points;
  }

  (double, double) _getMinMaxX() {
    final now = DateTime.now();
    final isToday = _isSameDay(_selectedDate, now);

    if (isToday) {
      return (
        now.subtract(_selectedRange.duration).millisecondsSinceEpoch.toDouble(),
        now.millisecondsSinceEpoch.toDouble(),
      );
    } else {
      final start = DateTime(_selectedDate.year, _selectedDate.month, _selectedDate.day).millisecondsSinceEpoch.toDouble();
      return (start, start + const Duration(hours: 24).inMilliseconds.toDouble());
    }
  }

  @override
  Widget build(BuildContext context) {
    final (minX, maxX) = _getMinMaxX();
    final isToday = _isSameDay(_selectedDate, DateTime.now());

    return Scaffold(
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 0,
        title: const Text(
          'Giám sát điện năng',
          style: TextStyle(color: Color(0xFF001F3F), fontWeight: FontWeight.bold),
        ),
        actions: [
          IconButton(
            icon: Icon(
              _showCalendar ? Icons.keyboard_arrow_up : Icons.calendar_month,
              color: const Color(0xFF001F3F),
            ),
            onPressed: () => setState(() => _showCalendar = !_showCalendar),
          ),
        ],
      ),
      body: SafeArea(
        child: Column(
          children: [
            // Lịch: chỉ hiển thị khi locale đã sẵn sàng
            AnimatedSize(
              duration: const Duration(milliseconds: 300),
              curve: Curves.easeInOut,
              child: _showCalendar
                  ? Container(
                      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: Colors.grey.shade200),
                        boxShadow: const [BoxShadow(color: Colors.black12, blurRadius: 10)],
                      ),
                      child: _localeReady
                          ? TableCalendar(
                              firstDay: DateTime.utc(2023, 1, 1),
                              lastDay: DateTime.now(),
                              focusedDay: _focusedDay,
                              currentDay: DateTime.now(),
                              selectedDayPredicate: (day) => _isSameDay(_selectedDate, day),
                              onDaySelected: _onDaySelected,
                              locale: 'vi_VN',
                              headerStyle: const HeaderStyle(
                                formatButtonVisible: false,
                                titleCentered: true,
                              ),
                              calendarStyle: CalendarStyle(
                                selectedDecoration: const BoxDecoration(
                                  color: Color(0xFF001F3F),
                                  shape: BoxShape.circle,
                                ),
                                todayDecoration: BoxDecoration(
                                  color: Colors.orange.shade700,
                                  shape: BoxShape.circle,
                                ),
                              ),
                            )
                          : const SizedBox(
                              height: 350,
                              child: Center(child: CircularProgressIndicator()),
                            ),
                    )
                  : const SizedBox.shrink(),
            ),

            // Toolbar
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Row(
                    children: [
                      const Icon(Icons.date_range, color: Color(0xFF001F3F), size: 20),
                      const SizedBox(width: 8),
                      Text(
                        isToday ? "Hôm nay" : DateFormat('dd/MM/yyyy').format(_selectedDate),
                        style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                      ),
                    ],
                  ),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12),
                    decoration: BoxDecoration(
                      color: isToday ? Colors.white : Colors.grey.shade100,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: Colors.grey.shade300),
                    ),
                    child: DropdownButtonHideUnderline(
                      child: DropdownButton<TimeRange>(
                        value: isToday ? _selectedRange : TimeRange.hour24,
                        icon: const Icon(Icons.keyboard_arrow_down, size: 20, color: Colors.grey),
                        style: const TextStyle(color: Colors.black87, fontSize: 14, fontWeight: FontWeight.w500),
                        onChanged: isToday
                            ? (v) {
                                if (v != null) _switchRange(v);
                              }
                            : null,
                        items: TimeRange.values
                            .map((e) => DropdownMenuItem(value: e, child: Text(e.label)))
                            .toList(),
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // Info Cards
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              child: Row(
                children: [
                  Expanded(child: _buildInfoItem('Điện áp', '${currentV.toStringAsFixed(1)} V', Colors.amber[700]!)),
                  const SizedBox(width: 12),
                  Expanded(child: _buildInfoItem('Dòng điện', '${currentI.toStringAsFixed(2)} A', Colors.blue[700]!)),
                  const SizedBox(width: 12),
                  Expanded(child: _buildInfoItem('Công suất', '${currentP.toStringAsFixed(0)} W', Colors.purple[600]!)),
                ],
              ),
            ),

            const SizedBox(height: 16),
            const Divider(height: 1, indent: 16, endIndent: 16),
            const SizedBox(height: 16),

            // Biểu đồ
            Expanded(
              child: LayoutBuilder(
                builder: (context, constraints) {
                  return Container(
                    width: constraints.maxWidth,
                    height: constraints.maxHeight,
                    padding: const EdgeInsets.fromLTRB(8, 0, 16, 24),
                    child: isLoading
                        ? const Center(child: CircularProgressIndicator())
                        : vSpots.isEmpty
                            ? const Center(child: Text('Chưa có dữ liệu', style: TextStyle(color: Colors.grey, fontSize: 16)))
                            : LineChart(
                                LineChartData(
                                  minX: minX,
                                  maxX: maxX,
                                  minY: 0,
                                  maxY: fixedMaxY,
                                  gridData: FlGridData(
                                    show: true,
                                    drawVerticalLine: false,
                                    horizontalInterval: fixedMaxY / 4,
                                    getDrawingHorizontalLine: (_) => FlLine(
                                      color: Colors.grey.withAlpha(50),
                                      strokeWidth: 1,
                                      dashArray: [5, 5],
                                    ),
                                  ),
                                  titlesData: FlTitlesData(
                                    show: true,
                                    rightTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                                    topTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                                    leftTitles: AxisTitles(
                                      sideTitles: SideTitles(
                                        showTitles: true,
                                        reservedSize: 40,
                                        interval: fixedMaxY / 4,
                                        getTitlesWidget: (v, _) => v == 0
                                            ? const SizedBox()
                                            : Text(v.toInt().toString(), style: const TextStyle(fontSize: 10, color: Colors.grey)),
                                      ),
                                    ),
                                    bottomTitles: AxisTitles(
                                      sideTitles: SideTitles(
                                        showTitles: true,
                                        reservedSize: 30,
                                        interval: (maxX - minX) / 5,
                                        getTitlesWidget: (v, _) {
                                          final dt = DateTime.fromMillisecondsSinceEpoch(v.toInt());
                                          String txt = (_selectedRange == TimeRange.hour24 || !isToday)
                                              ? DateFormat('HH:mm').format(dt)
                                              : DateFormat('mm:ss').format(dt);
                                          if (v == minX || v == maxX) return const SizedBox();
                                          return Padding(
                                            padding: const EdgeInsets.only(top: 6),
                                            child: Text(txt, style: const TextStyle(fontSize: 10, color: Colors.grey)),
                                          );
                                        },
                                      ),
                                    ),
                                  ),
                                  borderData: FlBorderData(
                                    show: true,
                                    border: const Border(
                                      bottom: BorderSide(color: Colors.grey, width: 1),
                                      left: BorderSide(color: Colors.grey, width: 1),
                                    ),
                                  ),
                                  lineBarsData: [
                                    _buildLine(vSpots, Colors.amber[700]!),
                                    _buildLine(iSpots, Colors.blue[700]!),
                                    _buildLine(pSpots, Colors.purple[600]!),
                                  ],
                                  lineTouchData: LineTouchData(
                                    touchTooltipData: LineTouchTooltipData(
                                      getTooltipColor: (_) => Colors.white,
                                      tooltipRoundedRadius: 8,
                                      tooltipBorder: BorderSide(color: Colors.grey.shade300),
                                      getTooltipItems: (spots) => spots.map((spot) {
                                        String unit = '';
                                        double val = spot.y;
                                        if (spot.barIndex == 0) unit = 'V';
                                        if (spot.barIndex == 1) { unit = 'A'; val /= 100; }
                                        if (spot.barIndex == 2) unit = 'W';
                                        return LineTooltipItem(
                                          '${val.toStringAsFixed(1)} $unit',
                                          TextStyle(color: spot.bar.color, fontWeight: FontWeight.bold, fontSize: 12),
                                        );
                                      }).toList(),
                                    ),
                                  ),
                                ),
                              ),
                  );
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildInfoItem(String label, String value, Color color) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          children: [
            Container(width: 10, height: 10, decoration: BoxDecoration(color: color, shape: BoxShape.circle)),
            const SizedBox(width: 8),
            Text(label, style: TextStyle(color: Colors.grey[700], fontSize: 13)),
          ],
        ),
        const SizedBox(height: 6),
        Text(value, style: const TextStyle(color: Color(0xFF001F3F), fontSize: 18, fontWeight: FontWeight.bold)),
      ],
    );
  }

  LineChartBarData _buildLine(List<FlSpot> spots, Color color) {
    return LineChartBarData(
      spots: spots,
      isCurved: true,
      curveSmoothness: 0.35,
      color: color,
      barWidth: 2.5,
      dotData: const FlDotData(show: false),
      belowBarData: BarAreaData(show: false),
    );
  }
}

class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) return web;
    throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform.');
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: "AIzaSyDmsxUiY_35EduINZwaoPJdbkNStrSc_6s",
    authDomain: "tu-dien-3943b.firebaseapp.com",
    databaseURL: "https://tu-dien-3943b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tu-dien-3943b",
    storageBucket: "tu-dien-3943b.firebasestorage.app",
    messagingSenderId: "835744421276",
    appId: "1:835744421276:web:5e16016516eedd34c7a459",
  );
}
